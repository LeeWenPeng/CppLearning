## 1  库概述

**库（Library）** 是一组预编译的函数、类或资源的集合，供程序在开发时调用。其目的是实现代码复用，避免重复编写通用功能（如数学计算、文件操作、网络通信等）。通过使用库，开发者可以专注于核心逻辑的实现。

库主要分为两种类型：

- **静态库（Static Library）**
- **动态库（Dynamic Library / Shared Library）**

## 2  静态库

静态库在**编译时**会被完整地复制到最终的可执行文件中。

### 2.1  创建静态库

静态库的创建通常使用 `ar` 工具，将多个目标文件（`.o`）打包为一个静态库文件（`.a`）。

![静态库制作过程\*1000](img/库文件/静态库制作过程.md)

**步骤一：编译为目标文件**

```bash
gcc -c 源文件.c -o 目标文件.o -Iinclude
```

- `-I`：指定头文件搜索路径

**步骤二：打包为静态库**

```bash
ar rcs lib库名.a 目标文件1.o 目标文件2.o …
```

- **`ar`**：创建、修改、提取库文件的工具
- **选项说明**：
  - `r`：替换或添加目标文件（若库中已存在则替换，否则新建）
  - `c`：静默创建（不显示警告）
  - `s`：为库中的符号创建索引，加速链接
- **命名规范**：
  - 前缀：`lib`
  - 库名：自定义
  - 后缀：Linux 为 `.a`，Windows 为 `.lib`

### 2.2  查看库内容

```bash
ar -t lib库名.a
```

- 显示库中包含的所有目标文件

### 2.3  链接静态库

```bash
gcc main.c -L库路径 -l库名 -o 可执行文件
```

- **`-L`**：指定库文件搜索路径（如当前目录：`-L.`）
- **`-l`**：指定要链接的库名（省略 `lib` 前缀和 `.a` 后缀）
  - 例如：`libmath.a` → `-lmath`

## 3  动态库

动态库在**程序运行时**才会被加载到内存中，多个程序可共享同一动态库。

### 3.1  动态库搜索路径

程序运行时，动态载入器按以下顺序搜索动态库：

1. ELF 文件的 `DT_RPATH` 段
2. 环境变量 `LD_LIBRARY_PATH`
3. `/etc/ld.so.cache`
4. 默认目录：`/lib` 和 `/usr/lib`

### 3.2  创建动态库

![动态库制作过程\*1000](img/库文件/动态库制作过程.md)

**步骤一：编译为位置独立代码**

```bash
gcc -c -fPIC 源文件.c -o 目标文件.o
```

- **`-fPIC`**：生成位置独立代码（Position Independent Code），动态库必需

**步骤二：生成动态库**

```bash
gcc -shared 目标文件1.o 目标文件2.o … -o lib库名.so
```

- **`-shared`**：指示生成共享库
- **命名规范**：
  - 前缀：`lib`
  - 库名：自定义
  - 后缀：Linux 为 `.so`，Windows 为 `.dll`

### 3.3  链接动态库

```bash
gcc 主程序.o -L库路径 -l库名 -o 可执行文件
```

- 编译时使用 `-L` 和 `-l` 指定库位置和名称

### 3.4  查看依赖库

```bash
ldd 可执行文件
```

- 显示程序依赖的所有动态库

### 3.5  配置动态库搜索路径

**方法一：设置 `LD_LIBRARY_PATH` 环境变量**

```bash
export LD_LIBRARY_PATH=/自定义库路径:$LD_LIBRARY_PATH
```

- 可将其添加到 `~/.bashrc` 或 `/etc/profile` 中永久生效

**方法二：更新系统配置**

```bash
# 1. 将库路径添加到/etc/ld.so.conf
sudo echo "/自定义库路径" >> /etc/ld.so.conf

# 2. 重新加载配置
sudo ldconfig
```

**方法三：复制到系统目录**（不推荐）

```bash
sudo cp lib库名.so /usr/lib/
```

## 4  静态库 vs 动态库对比

### 4.1  静态库优缺点

**优点：**
- 打包到应用程序中，加载速度快
- 发布程序无需提供库文件，移植性好

**缺点：**
- 消耗系统资源，内存占用大
- 更新、部署和发布麻烦（需重新编译整个程序）

### 4.2  动态库优缺点

**优点：**
- 多个进程可共享，节省内存
- 更新、部署简单（只需替换库文件）
- 可控制加载时机（动态加载）

**缺点：**
- 加载速度相对较慢
- 发布程序需提供依赖的动态库
- 存在版本兼容性问题

---

**总结：**
- **静态库**适合对性能要求高、依赖简单或需要独立分发的场景
- **动态库**适合需要共享代码、频繁更新或减少内存占用的场景

实际开发中可根据项目需求灵活选择库的类型，有时也会混合使用两种库。
