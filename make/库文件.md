

## 库

**库（Library）** 是一组预编译的函数、类或资源的集合，供程序在开发时调用。库的目的是为了代码复用，避免重复编写相同的功能。通过使用库，开发者可以专注于实现核心逻辑，而不必从头实现一些通用的功能（如数学计算、文件操作、网络通信等）。

库通常分为两种类型：**静态库** 和 **动态库**。

## 静态库

静态库在编译时会被完整地复制到最终的可执行文件中。

### 5.1. 静态链接

静态库的创建过程通常使用 `ar` 工具，它将多个目标文件（`.o`）打包为一个静态库文件（`.a`）。

#### 5.1.1. 创建静态库

##### 编译二进制 .o 文件

```bash
gcc -c [源文件.c] -o [目标文件.o] -Iinclude
```

+   `-I`：后面跟的参数是头文件的路径

##### 编库

```bash
ar rcs [lib自定义库名.a] [目标文件.o] [目标文件.o] ...
```

+ **`ar`**：工具用于创建、修改、提取库文件。
+ options：
    + `r`：**替换或添加目标文件**：若库中已有同名文件，则替换；若库不存在则新建。
    + `c`：**静默创建**：不显示库文件已存在的警告信息（若库不存在则直接创建）。
    + `s`：**生成索引**：为库中的符号（函数/变量）创建索引，加速链接过程。
+ **`lib库名.a`**：静态库文件命名
    + 前缀：`lib`
    + 库名：自定义
    + 后缀：Linux上固定为`.a`，Windows上固定为`.lib`
+ `目标文件.o`：通过`gcc -c`编译源码获取


#### 5.1.2. 查看库文件内容

使用 `ar -t` 查看库文件中的内容

```shell
ar -t lib自定义库名.a
```

+ 输出将显示库中包含的所有目标文件

#### 5.1.3. 在程序中链接静态库

将目标文件链接成执行文件时，也可以链接库文件。

```shell
gcc main.c -L/path/to/library -lxxx -o exec
```

+ **`-L`**：指定库的路径。
    + 如果库位于当前目录，`-L.` 即可。

+ **`-l`**：指定要链接的静态库库名。
    + `-l` 后面跟库的名称，也就是，库文件名省略 `lib` 和 `.a` 后缀。
    + 比如，库文件为 `libxxx.a` 被指定为 `-lxxx`。

+ **`-o exec`**：指定输出的可执行文件名为 `exec`。

## 动态库

动态库在程序运行时才会被加载到内存中，多个程序可以共享同一个动态库。

### 5.2. 动态链接

在 C 编程中，**动态链接**使用动态库（`.so` 文件），生成的可执行文件在运行时需要依赖这些外部库。通过使用动态库，可以在多个程序之间共享代码，减少内存占用并简化程序的更新。

#### 5.2.3. 动态库搜索路径

1. **在编译时**：通过 `-L` 选项指定动态库的搜索路径，将相关的符号（如函数、变量）链接到可执行文件。
2. **在运行时**：操作系统会从系统的库路径中加载并链接动态库。动态载入器先后搜索
    + elf 文件的 `DT_RPATH`
    + 环境变量 `LD_LIBRARY_PATH`
    + `/etc/ld.so.cache`
    + `/lib` 和 `/usr/lib` 

#### 5.2.4. 创建动态库

##### 编译二进制 .o 文件

```shell
gcc -c -fPIC -shared <input[s]>
```

+ **`-fPIC`**：生成**位置独立代码**（Position Independent Code），这是创建动态库时的要求。

##### 编库

```bash
gcc -shared [.o] [.o] ... -o libxxx.so 
```

+ **`-shared`**：指示编译器生成共享库文件。
+ **`libxxx.so`**：生成的动态库文件。
    + 前缀：`lib`
    + 库名
    + 后缀：
        + Linux：`.so`（可执行文件）
        + Windows：`.dll`


#### 5.2.5. 链接动态库到可执行文件

```bash
gcc [.o] -L/path/to/libs -lmylib -o exec
```

+ `-L`：指定动态库的搜索路径，告诉编译器在哪里找到 `.so` 文件。
    + `/path/to/libs`：库文件目录。
+ `-l`：指定动态库名称，告诉编译器动态库的名称是什么。
    + `mylib`：动态库名。`libmylib.so`去掉 `lib` 前缀和 `.so` 后缀，只保留`mylib`。

>[!note]
>编译时使用 **`-L`** 和 **`-l`** 选项指定库文件位置和名称。

#### 查看文件所依赖的动态库

通过命令 `ldd` 查看动态库

```bash
ldd file
```

#### 配置动态库搜索路径

根据动态库搜索路径，添加动态库路径到搜索路径中

方法一：修改环境变量中的`LD_LIBRARY_PATH`，将动态库路径添加进去即可

+   注意：看情况是否写入到系统配置文件中
    +   ubuntu：用户配置文件`~/.bashrc`；系统配置文件`/etc/profile`
    +   archlinux：用户配置文件`~/.bashrc`；系统配置文件`/etc/profile`

方法二：将动态库加载到`/etc/ld.so.cache`中

```shell
# 1 编辑 /etc/ld.so.conf 文件，将动态库路径粘贴到该文件中
sudo vim /etc/ld.so.conf
# 2 重载配置文件
sudo ldconfig
```

方法三： 将动态库文件放置到`/lib`或`/usr/lib`目录中——不建议使用

## 静态库和动态库对比

