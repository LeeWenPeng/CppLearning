![[C_C++语言编译过程|1000]]

## 1  前言

gcc 对源码的编译是直接将源码编译链接成可执行文件的，但其实这个过程是经历了四步的，分别是：

1.   预处理
2.   编译
3.   汇编
4.   生成可执行文件

## 2  编译的四个步骤

### 2.1  预处理

#### 2.1.1  作用

**预处理器（cpp**）处理源代码中的预处理指令，生成一个不含预处理指令的 C 语言程序文件（`.i`文件）。

#### 2.1.2  具体操作

1. 头文件展开：
    +   替换 `#include` 指令，将包含的头文件内容插入到对应位置。

2. 宏替换：

    + 替换 `#define` 定义的宏为具体值。

    + 处理条件编译指令（如 `#ifdef`、`#endif`）。

3. 注释删除：
    +   删除所有 C 和 C++ 样式的注释（`/* … */` 和 `//`）。

4. 生成纯净的代码：
    +   生成预处理后的代码文件（一般为 `.i` 文件），方便后续编译阶段使用。

#### 2.1.3  语法

使用 `gcc` 的 `-E` 选项可以执行预处理，并生成 `.i` 文件。

```bash
gcc -E input.c -o output.i
```

+ **`-E`**：仅执行预处理操作。

### 2.2  编译

#### 2.2.1  作用

**将预处理后的代码（`.i`文件）转换为对应的汇编代码（`.s`文件）**。

#### 2.2.2  具体操作

-   语法和语义分析。
-   生成中间代码（IR，如 LLVM IR）。
-   优化代码（根据 `-O` 选项的优化级别）。
-   最终生成平台相关的汇编代码。

#### 2.2.3  语法

使用 `gcc` 的 `-S` 选项可以生成汇编代码，并输出到文件中。

```bash
gcc -S input.c -o output.s
```

+ **`-S`**：编译到汇编语言阶段，生成汇编代码文件。

>[!note]
>+ 使用 `cat`、`less` 等工具查看汇编文件内容
>+ 汇编代码的具体内容取决于目标平台的架构（如 x86、ARM），因此在不同的硬件或交叉编译环境下，生成的代码会有所不同。

#### 2.2.4  额外功能

1. **调试和优化**：
+ 开发者可以**通过汇编代码分析编译器的优化策略或发现代码性能问题**。
2. **低级语言分析**：
    + 对系统编程或性能关键代码的开发者，生成汇编语言有助于理解代码在硬件上的实际运行方式。

### 2.3  汇编

#### 2.3.1  作用

将汇编代码（`.s` 文件）**转换为目标文件**（`.o` 文件），即机器码。

#### 2.3.2  语法

```shell
# 单文件编译
gcc -c input.c -o output.o

# 多文件编译
gcc -c input1.c input2.c
```

+   `-c`：Compile Only，仅编译源文件到目标文件，不执行链接操作。
+   `-o`：指定输出文件，默认生成与`.c`文件同名的`.o`文件。
    +   多文件编译时无法指定，按照默认处理

### 2.4  链接

#### 2.4.1  **作用**

将多个目标文件（`.o` 文件）和库文件（`.a` 或 `.so`）**合并为可执行文件**。

#### 2.4.2  具体操作

1. 解析和匹配目标文件之间的未定义符号。
2. 合并各个目标文件的代码段、数据段等内容。
3. 加载需要的静态库或动态库。
4. 生成一个可以在操作系统环境中运行的可执行文件。

#### 2.4.3  语法

```shell
gcc <inputs> -o <output>
```

+   `inputs`：可以是`.c`文件，也可以是`.s`文件

## 3  一次到位

GCC 可以自动完成所有步骤

```bash
gcc main.c xxx.c xxx.c -o myprogram -I/path/of/headfiles
```

+   `-I`：指定头文件目录
