## 1  Makefile 文件命名的相关规则

make 工具根据 Makefile 文件中的规则对文件进行更新。

### 1.1  自动查找

Make 会**自动查找** Makefile 文件，查找顺序为：**GNUmakefile -> makefile -> Makefile**

- GNUmakefile：不建议使用，只有 GNU make 会识别，其他版本 make 工具不会识别
- makefile：可以使用
- Makefile：推荐使用

> Make 会执行查找到的第一个 Makefile 文件，如果三个文件都没有找到，就会报错

### 1.2  手动查找

可以手动指定文件名

```cpp
make -f filename
make --file=filename
```

> [!tip]
> 手动指定后，Make 就会使用指定文件，就不会通过自动查找 makefile 文件执行

## 2  Makefile 文件内容组成

一个 Makefile 文件由五种类型的内容组成：显式规则、隐式规则、变量定义、指令和注释

- **显式规则**：显示指明何时以及如何生成或更新目录文件，显式规则包括目标、依赖和更新方法三部分
- **隐式规则**：根据文件自动推导如何从依赖生成或更新目标文件
- **变量定义**：定义变量并指定值，值都是字符串，类似于 C 语言宏定义 `#define`，在使用时将值展开到引用位置（字符串替换）
- **指令**：在 make 读取 Makefile 时做一些特别操作，包括
	1. 读取（包括）另一个 Makefile 文件（类似于 C 语言中的 `#include`）
	2. 确定是否使用或略过 Makefile 文件中的部分内容（类似于 C 语言中的 `#if`)
	3. 定义多行变量
- **注释**：一行当中 `#` 后的内容都是注释，不会被 make 执行，make 只有单行注释，如果需要使用 `#` 符号，则需要使用转义字符 `\#`

Makefile 文件中，**规则书写顺序为目标的依赖顺序**。换句话说，其书写顺序，与编译顺序相反。

## 3  工作原理

### 3.1  更新原理

make 的核心是依赖**关系树**和**时间戳**检查。

- 比较目标和先决条件的修改时间
- 如果先决条件更新，或目标不存在，则执行 recipe 进行更新

## 4  make 执行 Makefile 文件的两个阶段

GUN make 分为两个阶段来执行 Makefile 文件：

第一阶段（读取阶段）：

- 将 Makefile 文件的内容读取到 make 的内存中
- 根据 Makefile 文件构建变量
- 在程序内构建起显式规则、隐式规则
- 建立目标和依赖之间的依赖图

第二阶段（目标更新阶段）：

- 用第一阶段构建起来的数据确定需要更新的目标，执行对应的更新方法
