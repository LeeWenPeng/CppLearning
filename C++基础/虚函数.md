## 1  一、虚函数与多态性

### 1.1  基本概念

- **虚函数**：用 `virtual` 关键字声明的成员函数，用于实现**动态多态**。
- **多态性**：同一接口表现出多种行为，是面向对象设计的核心。
    - **静态多态**：编译时确定，如函数重载、模板。
    - **动态多态**：运行时确定，通过**虚函数 + 指针/引用**实现。

### 1.2  实现机制：虚函数表

每个包含虚函数的类都有一个**虚函数表**，其实现遵循以下原则：

- **虚表（vtable）**：
    - 编译器为每个**有虚函数的类**生成一个隐藏的静态数组（虚表）。
    - 表中按顺序存放该类所有**虚函数的入口地址**。
    - 虚表在编译时生成，存在于程序的**只读数据段**。

- **虚表指针（vptr）**：
    - 每个该类的对象内部都有一个隐藏的指针成员（vptr），指向类的虚表。
    - vptr 通常位于对象内存布局的**起始位置**（取决于编译器）。
    - 对象在构造时，由构造函数将其 vptr 初始化为指向正确的虚表。

### 1.3  动态绑定的过程

当通过**基类指针或引用**调用虚函数时：

1. 通过对象的 vptr 找到其所属类的虚表。
2. 在虚表中查找该虚函数的对应条目。
3. 调用该条目指向的函数地址。

这个过程在运行时完成，因此能够根据**对象的实际类型**调用正确的函数覆盖版本。

### 1.4  内存布局示例

```cpp
class Base {
public:
    virtual void func1() {}
    virtual void func2() {}
    int a;
};

class Derived : public Base {
public:
    virtual void func1() override {} // 覆盖 Base::func1
    virtual void func3() {}          // 新的虚函数
    int b;
};
```

内存布局示意：

```cpp
Base 对象：
+---------+
| vptr    | -> 指向 Base 的虚表 [&Base::func1, &Base::func2]
+---------+
| a       |
+---------+

Base 虚表：
+---------+
| &func1  |
+---------+
| &func2  |
+---------+

Derived 对象：
+---------+
| vptr    | -> 指向 Derived 的虚表 [&Derived::func1, &Base::func2, &Derived::func3]
+---------+
| a       |
+---------+
| b       |
+---------+

Derived 虚表：
+---------+
| &func1  | // 被覆盖
+---------+
| &func2  | // 继承
+---------+
| &func3  | // 新增
+---------+
```

---

## 2  二、纯虚函数与抽象类

### 2.1  纯虚函数

- 声明方式：`virtual 返回类型 函数名(参数列表) = 0;`
- 作用：明确告诉编译器该函数**没有默认实现**，必须在派生类中覆盖。

### 2.2  抽象类

- 定义：包含**至少一个纯虚函数**的类。
- 特性：
    1. **不能实例化**对象。
    2. 可以包含数据成员、普通成员函数和其他虚函数。
    3. 主要用作接口定义和基类。

### 2.3  继承要求

- 派生类必须**实现所有纯虚函数**，否则它也会成为抽象类。
- 实现时不需要再写 `virtual` 关键字（可写 `override` 以增强可读性）。

---

## 3  三、关键要点总结

| 特性 | 虚函数 | 纯虚函数 |
|------|--------|----------|
| 声明 | `virtual 返回类型 函数名(…)` | `virtual 返回类型 函数名(…) = 0` |
| 实现 | 可以有默认实现 | 无默认实现（但 C++11 后可为纯虚函数提供默认实现） |
| 所在类 | 可以是具体类或抽象类 | 使类成为抽象类 |
| 实例化 | 类可实例化（如果没有其他纯虚函数） | 类不能实例化 |
| 目的 | 允许派生类覆盖，实现多态 | 强制派生类提供实现，定义接口 |

### 3.1  核心设计理念

- **虚函数**：提供 "**可选的**、可定制的 " 行为。
- **纯虚函数**：定义 "**必须的**、强制的 " 接口契约。
- **抽象类**：作为抽象概念的蓝图，分离接口与实现，支持 " 面向接口编程 "。
